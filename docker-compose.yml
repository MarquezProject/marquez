version: "3.7"
services:
  api:
    image: "marquezproject/marquez:${TAG}"
    container_name: marquez-api
    environment:
      - MARQUEZ_PORT=${API_PORT}
      - MARQUEZ_ADMIN_PORT=${API_ADMIN_PORT}
      - MARQUEZ_CONFIG=/usr/src/app/config.yml
      - POSTGRES_DB=marquez_preprod
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PASSWORD=3ae43bdbfa9073bea78e3a15f95acad3
      - POSTGRES_PORT=60901
      - POSTGRES_USER=marquez_preprod
    network_mode: host
    ports:
      - "${API_PORT}:${API_PORT}"
      - "${API_ADMIN_PORT}:${API_ADMIN_PORT}"
      - "60901:60901"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - data:/opt/marquez
#    links:
#      - "db:postgres"
#    depends_on:
#      - db
#    entrypoint: ["/opt/marquez/wait-for-it.sh", "db:5432", "--", "./entrypoint.sh"]
    entrypoint: ["./entrypoint.sh"]

#  db:
#    image: postgres:14
#    container_name: marquez-db
#    ports:
#      - "5432:5432"
#    environment:
#      - POSTGRES_USER=postgres
#      - POSTGRES_PASSWORD=password
#      - MARQUEZ_DB=marquez
#      - MARQUEZ_USER=marquez
#      - MARQUEZ_PASSWORD=marquez
#    volumes:
#      - db-conf:/etc/postgresql
#      - db-init:/docker-entrypoint-initdb.d
#      - db-backup:/var/lib/postgresql/data
#    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
#    # Enables SQL statement logging (see: https://www.postgresql.org/docs/12/runtime-config-logging.html#GUC-LOG-STATEMENT)
#    # command: ["postgres", "-c", "log_statement=all"]

volumes:
  data:
  db-conf:
  db-init:
  db-backup:
